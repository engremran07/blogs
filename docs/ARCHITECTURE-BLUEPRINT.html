<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyBlog â€” Architecture Blueprint &amp; Restructure Plan</title>
    <style>
      :root {
        --bg: #0d1117;
        --surface: #161b22;
        --border: #30363d;
        --text: #e6edf3;
        --muted: #8b949e;
        --accent: #58a6ff;
        --green: #3fb950;
        --red: #f85149;
        --orange: #d29922;
        --purple: #bc8cff;
        --cyan: #39d353;
        --pink: #f778ba;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }
      h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--accent), var(--purple));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
      }
      h2 {
        font-size: 1.8rem;
        color: var(--accent);
        margin: 2.5rem 0 1rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.5rem;
      }
      h3 {
        font-size: 1.3rem;
        color: var(--purple);
        margin: 1.5rem 0 0.75rem;
      }
      h4 {
        font-size: 1.1rem;
        color: var(--cyan);
        margin: 1rem 0 0.5rem;
      }
      p,
      li {
        color: var(--text);
      }
      .subtitle {
        color: var(--muted);
        font-size: 1.1rem;
        margin-bottom: 2rem;
      }
      .badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 6px;
      }
      .badge-green {
        background: rgba(63, 185, 80, 0.15);
        color: var(--green);
        border: 1px solid rgba(63, 185, 80, 0.3);
      }
      .badge-red {
        background: rgba(248, 81, 73, 0.15);
        color: var(--red);
        border: 1px solid rgba(248, 81, 73, 0.3);
      }
      .badge-orange {
        background: rgba(210, 153, 34, 0.15);
        color: var(--orange);
        border: 1px solid rgba(210, 153, 34, 0.3);
      }
      .badge-blue {
        background: rgba(88, 166, 255, 0.15);
        color: var(--accent);
        border: 1px solid rgba(88, 166, 255, 0.3);
      }
      .badge-purple {
        background: rgba(188, 140, 255, 0.15);
        color: var(--purple);
        border: 1px solid rgba(188, 140, 255, 0.3);
      }

      .grid {
        display: grid;
        gap: 1.5rem;
      }
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
      .grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }
      .grid-4 {
        grid-template-columns: 1fr 1fr 1fr 1fr;
      }
      @media (max-width: 900px) {
        .grid-2,
        .grid-3,
        .grid-4 {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.25rem;
      }
      .card-header {
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card-stat {
        font-size: 2rem;
        font-weight: 700;
      }
      .card-label {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .tree {
        font-family: "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
        font-size: 0.8rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.25rem;
        overflow-x: auto;
        white-space: pre;
        line-height: 1.5;
      }
      .tree .new {
        color: var(--green);
        font-weight: 600;
      }
      .tree .move {
        color: var(--orange);
      }
      .tree .del {
        color: var(--red);
        text-decoration: line-through;
      }
      .tree .keep {
        color: var(--muted);
      }
      .tree .folder {
        color: var(--accent);
        font-weight: 600;
      }
      .tree .group {
        color: var(--purple);
        font-weight: 600;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
      }
      th {
        background: var(--surface);
        color: var(--accent);
        text-align: left;
        padding: 10px 14px;
        border-bottom: 2px solid var(--border);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      td {
        padding: 8px 14px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }
      tr:hover td {
        background: rgba(88, 166, 255, 0.05);
      }
      code {
        font-family: "JetBrains Mono", "Fira Code", monospace;
        background: rgba(88, 166, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
        color: var(--cyan);
      }
      .severity-critical {
        color: var(--red);
        font-weight: 700;
      }
      .severity-high {
        color: var(--orange);
        font-weight: 600;
      }
      .severity-medium {
        color: var(--orange);
      }
      .severity-low {
        color: var(--muted);
      }

      .phase {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        position: relative;
      }
      .phase::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        border-radius: 8px 0 0 8px;
      }
      .phase-1::before {
        background: var(--accent);
      }
      .phase-2::before {
        background: var(--green);
      }
      .phase-3::before {
        background: var(--purple);
      }
      .phase-4::before {
        background: var(--red);
      }
      .phase-5::before {
        background: var(--orange);
      }
      .phase-6::before {
        background: var(--cyan);
      }
      .phase-7::before {
        background: var(--pink);
      }
      .phase-8::before {
        background: var(--accent);
      }
      .phase-9::before {
        background: var(--green);
      }
      .phase-10::before {
        background: var(--purple);
      }
      .phase-11::before {
        background: var(--orange);
      }
      .phase-12::before {
        background: var(--cyan);
      }

      .toc {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 2rem 0;
      }
      .toc a {
        color: var(--accent);
        text-decoration: none;
      }
      .toc a:hover {
        text-decoration: underline;
      }
      .toc ol {
        padding-left: 1.5rem;
      }
      .toc li {
        margin: 4px 0;
      }

      .comparison {
        display: grid;
        grid-template-columns: 1fr 40px 1fr;
        gap: 0;
        align-items: start;
        margin: 1.5rem 0;
      }
      .comparison-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--green);
        padding-top: 2.5rem;
      }

      .cost-bar {
        height: 8px;
        border-radius: 4px;
        margin-top: 4px;
      }
      .cost-low {
        background: var(--green);
      }
      .cost-med {
        background: var(--orange);
      }
      .cost-high {
        background: var(--red);
      }

      .check {
        color: var(--green);
      }
      .cross {
        color: var(--red);
      }
      .warn {
        color: var(--orange);
      }

      .tag {
        display: inline-block;
        padding: 1px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
      }
      .tag-next {
        background: #000;
        color: #fff;
        border: 1px solid #333;
      }
      .tag-prisma {
        background: #1a202c;
        color: #5a67d8;
        border: 1px solid #2d3748;
      }
      .tag-react {
        background: #1a2332;
        color: #61dafb;
        border: 1px solid #2a3a4e;
      }
      .tag-ts {
        background: #1a2332;
        color: #3178c6;
        border: 1px solid #2a3a4e;
      }

      details {
        margin: 0.5rem 0;
      }
      summary {
        cursor: pointer;
        color: var(--accent);
        font-weight: 500;
        padding: 4px 0;
      }
      summary:hover {
        color: var(--purple);
      }

      .hero-stats {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin: 1.5rem 0;
      }
      .hero-stat {
        text-align: center;
      }
      .hero-stat .num {
        font-size: 2.5rem;
        font-weight: 800;
      }
      .hero-stat .label {
        font-size: 0.8rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .timeline {
        position: relative;
        padding-left: 30px;
      }
      .timeline::before {
        content: "";
        position: absolute;
        left: 12px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border);
      }
      .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -22px;
        top: 6px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid var(--accent);
        background: var(--bg);
      }
      .timeline-item.done::before {
        background: var(--green);
        border-color: var(--green);
      }

      .alert {
        padding: 1rem 1.25rem;
        border-radius: 8px;
        margin: 1rem 0;
        border-left: 4px solid;
      }
      .alert-danger {
        background: rgba(248, 81, 73, 0.08);
        border-color: var(--red);
      }
      .alert-warn {
        background: rgba(210, 153, 34, 0.08);
        border-color: var(--orange);
      }
      .alert-info {
        background: rgba(88, 166, 255, 0.08);
        border-color: var(--accent);
      }
      .alert-success {
        background: rgba(63, 185, 80, 0.08);
        border-color: var(--green);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- HERO                                                               -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h1>MyBlog â€” Architecture Blueprint</h1>
      <p class="subtitle">
        Comprehensive restructuring plan: Feature-First enhanced with Route
        Groups, Server Actions, Job Runner, and full type-safety audit â€”
        targeting zero <code>any</code>, zero double-casts, zero ESLint/TS/build
        errors.
      </p>

      <div class="hero-stats">
        <div class="hero-stat">
          <div class="num" style="color: var(--accent)">12</div>
          <div class="label">Phases</div>
        </div>
        <div class="hero-stat">
          <div class="num" style="color: var(--green)">48</div>
          <div class="label">Prisma Models</div>
        </div>
        <div class="hero-stat">
          <div class="num" style="color: var(--purple)">79</div>
          <div class="label">API Routes</div>
        </div>
        <div class="hero-stat">
          <div class="num" style="color: var(--orange)">12</div>
          <div class="label">Feature Modules</div>
        </div>
        <div class="hero-stat">
          <div class="num" style="color: var(--red)">156</div>
          <div class="label">Double Casts to Fix</div>
        </div>
        <div class="hero-stat">
          <div class="num" style="color: var(--pink)">90+</div>
          <div class="label">Loose <code>any</code> to Fix</div>
        </div>
        <div class="hero-stat">
          <div class="num" style="color: var(--cyan)">42</div>
          <div class="label">File Moves</div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- TABLE OF CONTENTS                                                  -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="toc">
        <h3 style="margin-top: 0">Table of Contents</h3>
        <ol>
          <li><a href="#tech-stack">Tech Stack &amp; Current State</a></li>
          <li><a href="#current-structure">Current Directory Structure</a></li>
          <li>
            <a href="#target-structure"
              >Target Directory Structure (After Restructure)</a
            >
          </li>
          <li><a href="#structure-comparison">Before â†’ After Comparison</a></li>
          <li><a href="#cost-analysis">Cost-Effectiveness Analysis</a></li>
          <li><a href="#rendering">Rendering Strategy Per Route</a></li>
          <li><a href="#redis-keys">Redis Key Map &amp; TTL Strategy</a></li>
          <li>
            <a href="#audit-findings">Full Audit Findings</a>
            <ol>
              <li><a href="#audit-casts">Double Casts (as unknown as)</a></li>
              <li>
                <a href="#audit-any">Loose <code>any</code> Annotations</a>
              </li>
              <li>
                <a href="#audit-json">JSON.parse &amp; Non-null Assertions</a>
              </li>
              <li><a href="#audit-zod">Zod / Prisma / API Misalignment</a></li>
              <li><a href="#audit-frontend">Frontend Data Flow Issues</a></li>
              <li><a href="#audit-security">Security Audit</a></li>
              <li>
                <a href="#audit-dead">Dead Code &amp; Unused Dependencies</a>
              </li>
            </ol>
          </li>
          <li><a href="#phases">Implementation Phases (1â€“12)</a></li>
          <li><a href="#job-runner">Job Runner Architecture</a></li>
          <li><a href="#server-actions">Server Actions Migration Plan</a></li>
          <li><a href="#verification">Verification Checklist</a></li>
          <li><a href="#decisions">Key Architectural Decisions</a></li>
        </ol>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 1. TECH STACK                                                      -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="tech-stack">1. Tech Stack &amp; Current State</h2>

      <div class="grid grid-4">
        <div class="card">
          <div class="card-header">
            <span class="tag tag-next">Next.js</span> Framework
          </div>
          <div class="card-stat">16.1.6</div>
          <div class="card-label">
            App Router + proxy.ts (NOT middleware.ts)
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="tag tag-react">React</span> UI
          </div>
          <div class="card-stat">19.2.3</div>
          <div class="card-label">React Compiler enabled</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="tag tag-prisma">Prisma</span> ORM
          </div>
          <div class="card-stat">7.4.0</div>
          <div class="card-label">PostgreSQL 16 + 48 models</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="tag tag-ts">TypeScript</span> Lang
          </div>
          <div class="card-stat">5.x</div>
          <div class="card-label">Strict mode + Zod 4.3.6</div>
        </div>
      </div>

      <div class="grid grid-3" style="margin-top: 1rem">
        <div class="card">
          <div class="card-header">ğŸ¨ Styling</div>
          <p>Tailwind CSS v4 + Headless UI + Custom components</p>
          <p class="card-label" style="margin-top: 0.5rem">
            No MUI â€” leaner bundle, lower cost
          </p>
        </div>
        <div class="card">
          <div class="card-header">ğŸ” Auth</div>
          <p>NextAuth v5 (beta-30) + JWT strategy</p>
          <p class="card-label" style="margin-top: 0.5rem">
            6-level role system + capability-based RBAC
          </p>
        </div>
        <div class="card">
          <div class="card-header">âš¡ Cache</div>
          <p>Upstash Redis (HTTP mode) + ISR</p>
          <p class="card-label" style="margin-top: 0.5rem">
            Rate limiting via @upstash/ratelimit
          </p>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top: 1rem">
        <div class="card">
          <div class="card-header">ğŸ“¦ Infrastructure</div>
          <ul style="padding-left: 1.2rem; margin-top: 0.5rem">
            <li>Docker Compose: PostgreSQL 16 + Redis 7 (local dev)</li>
            <li>Vercel deployment (serverless functions)</li>
            <li>Standalone output mode (Linux only)</li>
            <li>Nodemailer for email (SMTP from SiteSettings)</li>
            <li>OpenAI SDK for SEO auto-enhancement</li>
          </ul>
        </div>
        <div class="card">
          <div class="card-header">ğŸ§ª Testing</div>
          <ul style="padding-left: 1.2rem; margin-top: 0.5rem">
            <li>Vitest 4 + Testing Library (component tests)</li>
            <li>Jest 30 (server-side service tests)</li>
            <li>Playwright 1.58 (E2E browser tests)</li>
            <li>MSW for API mocking</li>
            <li>jest-axe for accessibility</li>
          </ul>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 2. CURRENT STRUCTURE                                               -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="current-structure">2. Current Directory Structure</h2>
      <p style="margin-bottom: 1rem">
        The project currently follows
        <strong>Feature-First (Option B)</strong> â€” 12 feature modules with
        server/ui split. No route groups, no private folders, no boundary files.
      </p>

      <div class="tree">
        src/ â”œâ”€â”€ <span class="keep">proxy.ts</span> â† Next.js 16 entry (NOT
        middleware.ts) â”œâ”€â”€ <span class="folder">app/</span> â† Routing surface
        (FLAT â€” no groups) â”‚ â”œâ”€â”€ layout.tsx â† Root layout (wraps ALL in
        PublicShell â€” âš ï¸ leaks to admin) â”‚ â”œâ”€â”€ page.tsx â† Homepage (ISR 15min) â”‚
        â”œâ”€â”€ globals.css / favicon.ico â”‚ â”œâ”€â”€ robots.ts / sitemap.ts â”‚ â”œâ”€â”€
        about/page.tsx â† ISR 1 day â”‚ â”œâ”€â”€ blog/ â”‚ â”‚ â”œâ”€â”€ page.tsx â† ISR 10min â”‚ â”‚
        â””â”€â”€ [slug]/ â”‚ â”‚ â”œâ”€â”€ page.tsx â† ISR 1hr + generateStaticParams â”‚ â”‚ â””â”€â”€
        CommentSection.tsx â† âš ï¸ colocated (should be _ui/) â”‚ â”œâ”€â”€ tags/ â”‚ â”‚ â”œâ”€â”€
        page.tsx â† ISR 1hr â”‚ â”‚ â””â”€â”€ [slug]/page.tsx â† ISR 1hr +
        generateStaticParams â”‚ â”œâ”€â”€ contact/ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â””â”€â”€
        ContactForm.tsx â† âš ï¸ colocated â”‚ â”œâ”€â”€ search/ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â””â”€â”€
        SearchContent.tsx â† âš ï¸ colocated â”‚ â”œâ”€â”€ [slug]/page.tsx â† CMS pages (ISR
        1 day) â”‚ â”œâ”€â”€ login/ (page + layout) â”‚ â”œâ”€â”€ register/ (page + layout) â† 3
        identical metadata-only layouts â”‚ â”œâ”€â”€ profile/ (page + layout) â”‚ â”œâ”€â”€
        <span class="folder">admin/</span> â† âš ï¸ No route group, gets PublicShell
        HTML â”‚ â”‚ â”œâ”€â”€ layout.tsx â† Auth guard + AdminShell â”‚ â”‚ â”œâ”€â”€ AdminShell.tsx
        â† âš ï¸ colocated â”‚ â”‚ â”œâ”€â”€ page.tsx â† force-dynamic â”‚ â”‚ â”œâ”€â”€ posts/ (page,
        PostEditor, new/, [id]/edit/) â”‚ â”‚ â”œâ”€â”€ pages/ (page, PageEditor, new/,
        [id]/edit/) â”‚ â”‚ â”œâ”€â”€ tags/page.tsx â”‚ â”‚ â”œâ”€â”€ categories/page.tsx â”‚ â”‚ â”œâ”€â”€
        comments/page.tsx â”‚ â”‚ â”œâ”€â”€ users/page.tsx â”‚ â”‚ â”œâ”€â”€ settings/ (page,
        admin-bar/) â”‚ â”‚ â”œâ”€â”€ media/page.tsx â”‚ â”‚ â”œâ”€â”€ seo/ (page, fix/[id]/) â”‚ â”‚
        â”œâ”€â”€ menus/page.tsx â”‚ â”‚ â”œâ”€â”€ ads/page.tsx â”‚ â”‚ â”œâ”€â”€ distribution/page.tsx â”‚
        â”‚ â””â”€â”€ cron/page.tsx â”‚ â””â”€â”€ <span class="folder">api/</span> â† 79 route
        handlers â”‚ â”œâ”€â”€ auth/ (register, [...nextauth]) â”‚ â”œâ”€â”€ posts/ (route,
        [id], bulk) â”‚ â”œâ”€â”€ pages/ (route, [id], [identifier], bulk) â”‚ â”œâ”€â”€
        comments/ (route, [id], [id]/flag, [id]/vote, bulk) â”‚ â”œâ”€â”€ categories/
        (route, [id], bulk) â”‚ â”œâ”€â”€ tags/ (route, [id], bulk) â”‚ â”œâ”€â”€ media/ (route,
        [id], bulk, cleanup, folders, optimize, stats, upload-url) â”‚ â”œâ”€â”€ seo/
        (route, redirects) â”‚ â”œâ”€â”€ settings/ (route, [group], public,
        module-status, test-email) â”‚ â”œâ”€â”€ ads/ (16 sub-routes) â”‚ â”œâ”€â”€
        distribution/ (12 sub-routes) â”‚ â”œâ”€â”€ captcha/ (challenge, settings,
        verify) â”‚ â”œâ”€â”€ newsletter/ (subscribe, confirm, unsubscribe) â”‚ â”œâ”€â”€ cron/
        (route, history) â”‚ â”œâ”€â”€ users/ (route, bulk) â”‚ â”œâ”€â”€ profile/route.ts â”‚ â”œâ”€â”€
        contact/route.ts â”‚ â”œâ”€â”€ upload/route.ts â”‚ â”œâ”€â”€ health/route.ts â”‚ â”œâ”€â”€
        revalidate/route.ts â”‚ â”œâ”€â”€ og/route.tsx â”‚ â””â”€â”€ admin-bar/meta/route.ts â”‚
        â”œâ”€â”€ <span class="folder">features/</span> â† 12 domain modules
        (Feature-First âœ…) â”‚ â”œâ”€â”€ ads/ (index, types, server/6 files, ui/14
        components) â”‚ â”œâ”€â”€ auth/ (index, types, server/9 files) â”‚ â”œâ”€â”€ blog/
        (index, types, server/4 files) â”‚ â”œâ”€â”€ captcha/ (index, types, server/3,
        ui/2+providers/6, utils/5) â”‚ â”œâ”€â”€ comments/ (index, types, server/8
        files) â”‚ â”œâ”€â”€ distribution/ (index, types, server/8 files) â”‚ â”œâ”€â”€ editor/
        (index, types, extensions/7, ui/3) â”‚ â”œâ”€â”€ media/ (index, types,
        server/8+storage/4, ui/2) â”‚ â”œâ”€â”€ pages/ (index, types, server/5 files) â”‚
        â”œâ”€â”€ seo/ (index, types, server/11 files) â”‚ â”œâ”€â”€ settings/ (index, types,
        server/3, menu-builder/*, theme/*) â”‚ â””â”€â”€ tags/ (index, types, server/6
        files) â”‚ â”œâ”€â”€ <span class="folder">server/</span> â† Platform
        infrastructure â”‚ â”œâ”€â”€ api-auth.ts â† requireAuth + capability checks â”‚ â”œâ”€â”€
        auth.ts â† NextAuth v5 config â”‚ â”œâ”€â”€ db/prisma.ts â† Prisma singleton â”‚ â”œâ”€â”€
        cache/redis.ts â† Upstash Redis singleton â”‚ â”œâ”€â”€ env/index.ts â†
        Zod-validated env vars â”‚ â”œâ”€â”€ mail/index.ts â† Nodemailer (lazy SMTP) â”‚
        â”œâ”€â”€ observability/logger.ts â† JSON structured logger â”‚ â””â”€â”€
        wiring/index.ts â† DI container (388 lines, 17 exports) â”‚ â”œâ”€â”€
        <span class="folder">components/</span> â† Shared UI â”‚ â”œâ”€â”€ admin/
        (admin-bar/13 files, EditorContext, useSeoScore) â”‚ â”œâ”€â”€ blog/ (7
        components) â”‚ â”œâ”€â”€ layout/ (7 components: Header, Footer, PublicShell,
        Providers, etc.) â”‚ â”œâ”€â”€ providers/ (CsrfFetchInterceptor) â”‚ â””â”€â”€ ui/ (13
        components: Button, Modal, DataTable, FormFields, etc.) â”‚ â”œâ”€â”€
        <span class="folder">shared/</span> â† Shared utilities â”‚ â”œâ”€â”€
        sanitize.util.ts â”‚ â””â”€â”€ text.util.ts â”‚ â””â”€â”€
        <span class="folder">types/</span> â† Global TypeScript types â”œâ”€â”€
        global.d.ts â† Window augmentation (captcha SDKs) â””â”€â”€ prisma-helpers.ts â†
        PostListItem, AdminPostItem, etc.
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 3. TARGET STRUCTURE                                                -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="target-structure">
        3. Target Directory Structure (After Restructure)
      </h2>
      <p style="margin-bottom: 1rem">
        Enhanced Feature-First with Route Groups <code>(public)</code>,
        <code>(auth)</code>, <code>(admin)</code>, Private Folders
        <code>_ui/</code>, Boundary Files, Server Actions, Job Runner, and
        <code>instrumentation.ts</code>.
      </p>

      <div class="tree">
        src/ â”œâ”€â”€ <span class="keep">proxy.ts</span> â† Unchanged (Next.js 16 â€”
        CSP nonce, CSRF, rate limit) â”‚ â”œâ”€â”€ <span class="folder">app/</span> â”‚
        â”œâ”€â”€ layout.tsx â†
        <span class="new">SLIMMED: HTML shell + Providers + AdminBar ONLY</span>
        â”‚ â”œâ”€â”€ <span class="new">not-found.tsx</span> â† NEW: Custom 404 page â”‚
        â”œâ”€â”€ <span class="new">instrumentation.ts</span> â† NEW: OpenTelemetry /
        Vercel tracing â”‚ â”œâ”€â”€ globals.css / favicon.ico â”‚ â”œâ”€â”€ robots.ts /
        sitemap.ts â”‚ â”‚ â”‚ â”œâ”€â”€ <span class="group">(public)/</span> â† NEW Route
        Group (invisible to URLs) â”‚ â”‚ â”œâ”€â”€ <span class="new">layout.tsx</span> â†
        NEW: wraps in PublicShell (header/footer/ads) â”‚ â”‚ â”œâ”€â”€
        <span class="new">error.tsx</span> â† NEW: Public error boundary â”‚ â”‚ â”œâ”€â”€
        page.tsx â† MOVED from app/page.tsx â”‚ â”‚ â”œâ”€â”€ about/page.tsx â† MOVED â”‚ â”‚
        â”œâ”€â”€ blog/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â† MOVED â”‚ â”‚ â”‚ â”œâ”€â”€
        <span class="new">loading.tsx</span> â† NEW: Blog list skeleton â”‚ â”‚ â”‚ â””â”€â”€
        [slug]/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â† MOVED â”‚ â”‚ â”‚ â”œâ”€â”€
        <span class="new">loading.tsx</span> â† NEW: Post skeleton â”‚ â”‚ â”‚ â”œâ”€â”€
        <span class="new">error.tsx</span> â† NEW: Post error boundary â”‚ â”‚ â”‚ â””â”€â”€
        <span class="new">_ui/</span> â”‚ â”‚ â”‚ â””â”€â”€ CommentSection.tsx â† MOVED to
        private folder â”‚ â”‚ â”œâ”€â”€ tags/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â”‚ â”œâ”€â”€
        <span class="new">loading.tsx</span> â† NEW: Tags skeleton â”‚ â”‚ â”‚ â””â”€â”€
        [slug]/page.tsx â”‚ â”‚ â”œâ”€â”€ contact/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â”‚ â””â”€â”€
        <span class="new">_ui/</span>ContactForm.tsx â† MOVED to private folder â”‚
        â”‚ â”œâ”€â”€ search/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â”‚ â””â”€â”€
        <span class="new">_ui/</span>SearchContent.tsx â† MOVED to private folder
        â”‚ â”‚ â””â”€â”€ [slug]/page.tsx â† CMS pages â”‚ â”‚ â”‚ â”œâ”€â”€
        <span class="group">(auth)/</span> â† NEW Route Group â”‚ â”‚ â”œâ”€â”€
        <span class="new">layout.tsx</span> â† NEW: Merged from 3 layouts +
        robots:noindex â”‚ â”‚ â”œâ”€â”€ login/page.tsx â”‚ â”‚ â”œâ”€â”€ register/page.tsx â”‚ â”‚ â””â”€â”€
        profile/page.tsx â”‚ â”‚ â”‚ â”œâ”€â”€ <span class="group">(admin)/</span> â† NEW
        Route Group â”‚ â”‚ â””â”€â”€ admin/ â”‚ â”‚ â”œâ”€â”€ layout.tsx â† MOVED (auth guard +
        AdminShell) â”‚ â”‚ â”œâ”€â”€ <span class="new">loading.tsx</span> â† NEW: Admin
        skeleton â”‚ â”‚ â”œâ”€â”€ <span class="new">error.tsx</span> â† NEW: Admin error
        boundary â”‚ â”‚ â”œâ”€â”€ <span class="new">_ui/</span>AdminShell.tsx â† MOVED to
        private folder â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â”œâ”€â”€ posts/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â”‚
        â”œâ”€â”€ <span class="new">_ui/</span>PostEditor.tsx â”‚ â”‚ â”‚ â”œâ”€â”€ new/page.tsx â”‚
        â”‚ â”‚ â””â”€â”€ [id]/edit/page.tsx â”‚ â”‚ â”œâ”€â”€ pages/ â”‚ â”‚ â”‚ â”œâ”€â”€ page.tsx â”‚ â”‚ â”‚ â”œâ”€â”€
        <span class="new">_ui/</span>PageEditor.tsx â”‚ â”‚ â”‚ â”œâ”€â”€ new/page.tsx â”‚ â”‚ â”‚
        â””â”€â”€ [id]/edit/page.tsx â”‚ â”‚ â”œâ”€â”€ tags/page.tsx â”‚ â”‚ â”œâ”€â”€ categories/page.tsx
        â”‚ â”‚ â”œâ”€â”€ comments/page.tsx â”‚ â”‚ â”œâ”€â”€ users/page.tsx â”‚ â”‚ â”œâ”€â”€ settings/
        (page, admin-bar/) â”‚ â”‚ â”œâ”€â”€ media/page.tsx â”‚ â”‚ â”œâ”€â”€ seo/ (page, fix/[id]/)
        â”‚ â”‚ â”œâ”€â”€ menus/page.tsx â”‚ â”‚ â”œâ”€â”€ ads/page.tsx â”‚ â”‚ â”œâ”€â”€
        distribution/page.tsx â”‚ â”‚ â””â”€â”€ cron/page.tsx â”‚ â”‚ â”‚ â””â”€â”€
        <span class="folder">api/</span> â† Stays flat, add job endpoints â”‚ â”œâ”€â”€
        <span class="new">jobs/</span> â”‚ â”‚ â”œâ”€â”€
        <span class="new">enqueue/route.ts</span> â† NEW: Insert job into queue â”‚
        â”‚ â””â”€â”€ <span class="new">run/route.ts</span> â† NEW: Process one job step
        â”‚ â”œâ”€â”€ <span class="new">profile/password/route.ts</span> â† NEW: Fix
        broken self-service password â”‚ â””â”€â”€ ... (existing 79 routes unchanged) â”‚
        â”œâ”€â”€ <span class="folder">features/</span> â† Enhanced with Server Actions
        + Jobs â”‚ â”œâ”€â”€ <span class="new">jobs/</span> â† NEW: Autonomous workflow
        engine â”‚ â”‚ â”œâ”€â”€ server/ â”‚ â”‚ â”‚ â”œâ”€â”€ queue.ts â† enqueueJob(type, step,
        payload) â”‚ â”‚ â”‚ â”œâ”€â”€ runner.ts â† processNextJob() â€” picks PENDING, runs 1
        step â”‚ â”‚ â”‚ â”œâ”€â”€ dispatcher.ts â† Maps job type+step â†’ handler â”‚ â”‚ â”‚ â”œâ”€â”€
        idempotency.ts â† Redis dedup per job ID â”‚ â”‚ â”‚ â”œâ”€â”€ definitions.ts â†
        JobType enum + payload Zod schemas â”‚ â”‚ â”‚ â””â”€â”€ workflows/ â”‚ â”‚ â”‚ â”œâ”€â”€
        seo-planner.workflow.ts â”‚ â”‚ â”‚ â”œâ”€â”€ image-gen.workflow.ts â”‚ â”‚ â”‚ â”œâ”€â”€
        distribution.workflow.ts â”‚ â”‚ â”‚ â””â”€â”€ blog-autopublish.workflow.ts â”‚ â”‚ â””â”€â”€
        types.ts â”‚ â”‚ â”‚ â”œâ”€â”€ tags/server/<span class="new">actions.ts</span> â†
        NEW: Server Actions (createTag, updateTag, deleteTag) â”‚ â”œâ”€â”€
        blog/server/<span class="new">category-actions.ts</span> â† NEW: Server
        Actions â”‚ â”œâ”€â”€ media/server/<span class="new">folder-actions.ts</span> â†
        NEW: Server Actions â”‚ â”œâ”€â”€ settings/server/<span class="new"
          >actions.ts</span
        >
        â† NEW: Server Actions â”‚ â”œâ”€â”€ ads/server/<span class="new"
          >actions.ts</span
        >
        â† NEW: Server Actions â”‚ â”œâ”€â”€ distribution/server/<span class="new"
          >actions.ts</span
        >
        â† NEW: Server Actions â”‚ â”œâ”€â”€ auth/server/<span class="new"
          >actions.ts</span
        >
        â† NEW: Server Actions â”‚ â”œâ”€â”€ media/server/<span class="new"
          >actions.ts</span
        >
        â† NEW: Server Actions â”‚ â””â”€â”€ ... (12 existing modules â€” types/services
        ENHANCED with proper typing) â”‚ â”œâ”€â”€ <span class="folder">server/</span> â†
        Enhanced â”‚ â”œâ”€â”€ db/ â”‚ â”‚ â”œâ”€â”€ prisma.ts â† FIXED: declare global
        augmentation (no double cast) â”‚ â”‚ â””â”€â”€
        <span class="new">prisma-delegates.ts</span> â† NEW: AppPrismaClient
        intersection type â”‚ â””â”€â”€ ... (rest unchanged) â”‚ â”œâ”€â”€
        <span class="folder">shared/</span> â† Enhanced â”‚ â”œâ”€â”€ sanitize.util.ts â”‚
        â”œâ”€â”€ text.util.ts â”‚ â”œâ”€â”€ <span class="new">api-response.types.ts</span> â†
        NEW: ApiResponse&lt;T&gt; generic type â”‚ â””â”€â”€
        <span class="new">prisma-delegate.types.ts</span> â† NEW: Generic
        PrismaDelegate&lt;T&gt; â”‚ â”œâ”€â”€ <span class="folder">components/</span> â†
        Cleaned â”‚ â”œâ”€â”€ admin/ (admin-bar/13, EditorContext â€”
        <span class="del">useSeoScore.ts DELETED</span>) â”‚ â””â”€â”€ ... â”‚ â””â”€â”€
        <span class="folder">types/</span>
        â”œâ”€â”€ global.d.ts â””â”€â”€ prisma-helpers.ts â† CLEANED: removed dead TagItem,
        CommentItem
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 4. COMPARISON                                                      -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="structure-comparison">4. Before â†’ After Comparison</h2>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">âŒ Before (Current Issues)</div>
          <ul style="padding-left: 1.2rem">
            <li>Flat <code>app/</code> â€” no route groups</li>
            <li>PublicShell leaks into admin (header/footer HTML)</li>
            <li>3 identical auth layouts (login, register, profile)</li>
            <li>No <code>loading.tsx</code> â€” pages block until render</li>
            <li>No <code>error.tsx</code> â€” errors bubble to root</li>
            <li>No custom <code>not-found.tsx</code></li>
            <li>6 colocated components without <code>_ui/</code></li>
            <li>156 double casts (<code>as unknown as</code>)</li>
            <li>90+ loose <code>any</code> type annotations</li>
            <li>5 unvalidated <code>JSON.parse</code> calls</li>
            <li>8 API routes with missing Zod validation</li>
            <li>Broken self-service password change</li>
            <li>14 admin pages missing <code>res.ok</code> checks</li>
            <li>Job model scaffolded but unused</li>
            <li>Zero Server Actions (all 79 routes are API)</li>
            <li>3 dead npm packages</li>
            <li>No OpenTelemetry instrumentation</li>
          </ul>
        </div>
        <div class="card">
          <div class="card-header">âœ… After (Target State)</div>
          <ul style="padding-left: 1.2rem">
            <li>
              Route groups: <code>(public)</code>, <code>(auth)</code>,
              <code>(admin)</code>
            </li>
            <li>PublicShell only in <code>(public)/layout.tsx</code></li>
            <li>Single merged <code>(auth)/layout.tsx</code></li>
            <li>Loading skeletons for blog, tags, admin</li>
            <li>Error boundaries for public + admin + post</li>
            <li>Custom branded 404 page</li>
            <li>All colocated components in <code>_ui/</code> folders</li>
            <li>Zero double casts (proper types + Prisma generics)</li>
            <li>
              Zero loose <code>any</code> (generic delegates + typed services)
            </li>
            <li>All <code>JSON.parse</code> validated through Zod</li>
            <li>100% Zod validation on all mutation routes</li>
            <li>Working password change via dedicated endpoint</li>
            <li>All admin pages check <code>res.ok</code> + typed responses</li>
            <li>Full job runner with step-based workflows</li>
            <li>Server Actions for leaf CRUD (tags, categories, folders)</li>
            <li>Dead packages removed, clean deps</li>
            <li>OpenTelemetry instrumentation.ts</li>
          </ul>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 5. COST ANALYSIS                                                   -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="cost-analysis">5. Cost-Effectiveness Analysis</h2>

      <div class="grid grid-2">
        <div class="card">
          <h4>Vercel Compute Savings</h4>
          <table>
            <tr>
              <th>Strategy</th>
              <th>Impact</th>
              <th>Savings</th>
            </tr>
            <tr>
              <td>ISR on all public pages</td>
              <td>DB hit once per revalidation window, not per visit</td>
              <td style="color: var(--green)">~95% fewer DB queries</td>
            </tr>
            <tr>
              <td>Redis settings cache (TTL)</td>
              <td>Settings fetched from Redis, not Postgres</td>
              <td style="color: var(--green)">~80% fewer settings queries</td>
            </tr>
            <tr>
              <td>Server Actions (leaf CRUD)</td>
              <td>No round-trip through API route layer</td>
              <td style="color: var(--green)">
                ~15% less function invocations
              </td>
            </tr>
            <tr>
              <td>Step-based job runner</td>
              <td>Each step &lt;10s (no long-running functions)</td>
              <td style="color: var(--green)">Predictable compute budget</td>
            </tr>
            <tr>
              <td>Route Groups (code splitting)</td>
              <td>Admin code never loaded for public visitors</td>
              <td style="color: var(--green)">~40% smaller public JS bundle</td>
            </tr>
            <tr>
              <td><code>loading.tsx</code> (streaming)</td>
              <td>Faster TTFB via React Suspense streaming</td>
              <td style="color: var(--green)">Better Core Web Vitals</td>
            </tr>
          </table>
        </div>
        <div class="card">
          <h4>Monthly Cost Estimate (Vercel Hobby â†’ Pro)</h4>
          <table>
            <tr>
              <th>Component</th>
              <th>Cost</th>
              <th>Notes</th>
            </tr>
            <tr>
              <td>Vercel Pro</td>
              <td>$20/mo</td>
              <td>100GB bandwidth, 1000 builds</td>
            </tr>
            <tr>
              <td>Vercel Serverless</td>
              <td>$0â€“5/mo</td>
              <td>ISR keeps functions cold</td>
            </tr>
            <tr>
              <td>Neon/Supabase Postgres</td>
              <td>$0â€“25/mo</td>
              <td>Free tier â†’ Pro as traffic grows</td>
            </tr>
            <tr>
              <td>Upstash Redis</td>
              <td>$0â€“10/mo</td>
              <td>Pay-per-request, free tier generous</td>
            </tr>
            <tr>
              <td>Vercel Cron</td>
              <td>$0</td>
              <td>Included (1 job/hr), functions billed normally</td>
            </tr>
            <tr>
              <td>OpenAI API (SEO)</td>
              <td>$5â€“15/mo</td>
              <td>Background jobs only, controlled volume</td>
            </tr>
            <tr>
              <td style="font-weight: 700">Total</td>
              <td style="font-weight: 700; color: var(--green)">$25â€“75/mo</td>
              <td>Full-stack blog with autonomous AI</td>
            </tr>
          </table>
        </div>
      </div>

      <h3>Rendering Strategy Cost Map</h3>
      <table>
        <tr>
          <th>Route</th>
          <th>Method</th>
          <th>Revalidate</th>
          <th>Cost per 10K visits</th>
          <th>Note</th>
        </tr>
        <tr>
          <td><code>/</code> Homepage</td>
          <td>ISR</td>
          <td>900s (15min)</td>
          <td style="color: var(--green)">~96 DB hits</td>
          <td>Cache-first</td>
        </tr>
        <tr>
          <td><code>/blog</code></td>
          <td>ISR</td>
          <td>600s (10min)</td>
          <td style="color: var(--green)">~144 DB hits</td>
          <td>List page</td>
        </tr>
        <tr>
          <td><code>/blog/[slug]</code></td>
          <td>ISR + SSG</td>
          <td>3600s (1hr)</td>
          <td style="color: var(--green)">~10 DB hits</td>
          <td>generateStaticParams</td>
        </tr>
        <tr>
          <td><code>/tags</code></td>
          <td>ISR</td>
          <td>3600s (1hr)</td>
          <td style="color: var(--green)">~10 hits</td>
          <td>Cached</td>
        </tr>
        <tr>
          <td><code>/about</code></td>
          <td>ISR</td>
          <td>86400s (1d)</td>
          <td style="color: var(--green)">~1 hit</td>
          <td>Near-static</td>
        </tr>
        <tr>
          <td><code>/admin/*</code></td>
          <td>SSR</td>
          <td>force-dynamic</td>
          <td style="color: var(--orange)">1:1 (every visit)</td>
          <td>Auth-gated, low traffic</td>
        </tr>
      </table>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 6. RENDERING                                                       -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="rendering">6. Rendering Strategy Per Route</h2>
      <table>
        <tr>
          <th>Route</th>
          <th>Strategy</th>
          <th><code>revalidate</code></th>
          <th><code>generateStaticParams</code></th>
          <th><code>dynamic</code></th>
        </tr>
        <tr>
          <td><code>/</code></td>
          <td>ISR</td>
          <td>900</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/about</code></td>
          <td>ISR</td>
          <td>86400</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/blog</code></td>
          <td>ISR</td>
          <td>600</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/blog/[slug]</code></td>
          <td>ISR + SSG</td>
          <td>3600</td>
          <td>âœ…</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/tags</code></td>
          <td>ISR</td>
          <td>3600</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/tags/[slug]</code></td>
          <td>ISR + SSG</td>
          <td>3600</td>
          <td>âœ…</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/[slug]</code> (CMS)</td>
          <td>ISR + SSG</td>
          <td>86400</td>
          <td>âœ…</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/contact</code></td>
          <td>Static</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/search</code></td>
          <td>Static shell</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/login</code></td>
          <td>Static</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/register</code></td>
          <td>Static</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/profile</code></td>
          <td>Client</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>â€”</td>
        </tr>
        <tr>
          <td><code>/admin</code></td>
          <td>SSR</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>force-dynamic</td>
        </tr>
        <tr>
          <td><code>/admin/*</code></td>
          <td>SSR</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>via layout guard</td>
        </tr>
      </table>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 7. REDIS                                                           -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="redis-keys">7. Redis Key Map &amp; TTL Strategy</h2>
      <table>
        <tr>
          <th>Module</th>
          <th>Key Pattern</th>
          <th>TTL</th>
          <th>Purpose</th>
        </tr>
        <tr>
          <td>Rate Limit</td>
          <td><code>myblog:ratelimit:{ip}</code></td>
          <td>60s sliding</td>
          <td>30 req/60s per IP on mutations</td>
        </tr>
        <tr>
          <td rowspan="6">Blog</td>
          <td><code>blog:post:slug:{slug}</code></td>
          <td>300s</td>
          <td>Single post cache</td>
        </tr>
        <tr>
          <td><code>blog:posts:{hash}</code></td>
          <td>60s</td>
          <td>Post list queries</td>
        </tr>
        <tr>
          <td><code>blog:related:{postId}</code></td>
          <td>1800s</td>
          <td>Related posts</td>
        </tr>
        <tr>
          <td><code>blog:popular:{limit}</code></td>
          <td>300s</td>
          <td>Popular posts</td>
        </tr>
        <tr>
          <td><code>blog:rss</code></td>
          <td>1800s</td>
          <td>RSS feed cache</td>
        </tr>
        <tr>
          <td><code>blog:sitemap</code></td>
          <td>1800s</td>
          <td>Sitemap XML</td>
        </tr>
        <tr>
          <td rowspan="3">Pages</td>
          <td><code>pages:page:slug:{slug}</code></td>
          <td>120s</td>
          <td>Single page</td>
        </tr>
        <tr>
          <td><code>pages:tree</code></td>
          <td>600s</td>
          <td>Page hierarchy</td>
        </tr>
        <tr>
          <td><code>pages:home</code></td>
          <td>300s</td>
          <td>Homepage page</td>
        </tr>
        <tr>
          <td rowspan="2">SEO</td>
          <td><code>seo:audit:{targetId}</code></td>
          <td>1800s</td>
          <td>SEO audit cache</td>
        </tr>
        <tr>
          <td><code>seo:keywords</code></td>
          <td>86400s</td>
          <td>Keyword data</td>
        </tr>
        <tr>
          <td rowspan="2">Media</td>
          <td><code>media:item:id:{id}</code></td>
          <td>300s</td>
          <td>Media metadata</td>
        </tr>
        <tr>
          <td><code>media:folders:all</code></td>
          <td>600s</td>
          <td>Folder list</td>
        </tr>
        <tr>
          <td>Ads</td>
          <td><code>ads:placements</code></td>
          <td>config</td>
          <td>Active placements</td>
        </tr>
        <tr>
          <td>Jobs (NEW)</td>
          <td><code>jobs:lock:{jobId}</code></td>
          <td>30s</td>
          <td>Job execution lock</td>
        </tr>
        <tr>
          <td>Jobs (NEW)</td>
          <td><code>jobs:dedup:{type}:{hash}</code></td>
          <td>300s</td>
          <td>Idempotency guard</td>
        </tr>
      </table>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 8. AUDIT FINDINGS                                                  -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="audit-findings">8. Full Audit Findings</h2>

      <!-- 8.1 Double Casts -->
      <h3 id="audit-casts">
        8.1 Double Casts (<code>as unknown as</code>) â€” 156 occurrences
      </h3>
      <div class="alert alert-danger">
        <strong>Impact:</strong> Every double cast bypasses TypeScript's type
        system entirely. If the underlying data shape changes, you get silent
        runtime errors instead of compile-time catches.
      </div>
      <table>
        <tr>
          <th>Category</th>
          <th>Count</th>
          <th>Files</th>
          <th>Fix Approach</th>
        </tr>
        <tr>
          <td>Prisma DI client narrowing</td>
          <td>~40</td>
          <td><code>wiring/index.ts</code></td>
          <td>
            Create <code>AppPrismaClient</code> intersection type +
            <code>satisfies</code>
          </td>
        </tr>
        <tr>
          <td>Prisma query filters</td>
          <td>~15</td>
          <td><code>blog.service.ts</code>, <code>media.service.ts</code></td>
          <td>
            Use <code>Prisma.*WhereInput</code> /
            <code>Prisma.StringFilter</code>
          </td>
        </tr>
        <tr>
          <td>JSON field â†’ runtime type</td>
          <td>~12</td>
          <td>All <code>admin-settings.service.ts</code></td>
          <td>Zod schema validation at DB boundary</td>
        </tr>
        <tr>
          <td>SEO/Interlink subtypes</td>
          <td>~15</td>
          <td><code>seo/route.ts</code>, <code>seo.service.ts</code></td>
          <td>Make <code>InterlinkPrisma</code> structural subtype</td>
        </tr>
        <tr>
          <td>Ads UI Prisma</td>
          <td>~8</td>
          <td>
            <code>InArticleAd</code>, <code>GlobalAdSlots</code>,
            <code>AdContainer</code>
          </td>
          <td>Add to <code>AppPrismaClient</code> intersection</td>
        </tr>
        <tr>
          <td>Settings return type</td>
          <td>~10</td>
          <td>
            <code>sitemap.ts</code>, <code>robots.ts</code>,
            <code>layout.tsx</code>
          </td>
          <td>Type <code>SiteSettings</code> return properly</td>
        </tr>
        <tr>
          <td>Miscellaneous</td>
          <td>~10</td>
          <td>
            <code>prisma.ts</code>, <code>auth.ts</code>,
            <code>user.service.ts</code>
          </td>
          <td>Global augmentation, Omit&lt;&gt;, shape validation</td>
        </tr>
        <tr>
          <td>Test files</td>
          <td>~10</td>
          <td>Various test files</td>
          <td>
            Use <code>jest.mocked()</code> / <code>Partial&lt;T&gt;</code>
          </td>
        </tr>
        <tr>
          <td style="font-weight: 700">Total</td>
          <td style="font-weight: 700">~156</td>
          <td></td>
          <td></td>
        </tr>
      </table>

      <!-- 8.2 Loose any -->
      <h3 id="audit-any">
        8.2 Loose <code>any</code> Annotations â€” 90+ occurrences
      </h3>
      <table>
        <tr>
          <th>Category</th>
          <th>Count</th>
          <th>Files</th>
          <th>Fix</th>
        </tr>
        <tr>
          <td>Prisma DI delegate methods</td>
          <td>~80</td>
          <td>10 <code>types.ts</code> files</td>
          <td>Generic <code>PrismaDelegate&lt;T&gt;</code> interface</td>
        </tr>
        <tr>
          <td>Distribution service</td>
          <td>~15</td>
          <td><code>distribution.service.ts</code></td>
          <td>
            Define proper input/output types + <code>catch (err: unknown)</code>
          </td>
        </tr>
        <tr>
          <td>Ads service</td>
          <td>~12</td>
          <td><code>ads.service.ts</code></td>
          <td>Provider/Slot/Placement input types + return types</td>
        </tr>
        <tr>
          <td>Auth service</td>
          <td>1</td>
          <td><code>auth.service.ts</code></td>
          <td>Type <code>user</code> param as Prisma's <code>User</code></td>
        </tr>
        <tr>
          <td>Blog page</td>
          <td>1</td>
          <td><code>blog/page.tsx</code></td>
          <td><code>Prisma.PostWhereInput</code></td>
        </tr>
      </table>

      <!-- 8.3 JSON.parse & ! -->
      <h3 id="audit-json">8.3 JSON.parse &amp; Non-null Assertions</h3>
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">âš ï¸ Unvalidated JSON.parse (5 risky)</div>
          <table>
            <tr>
              <th>File</th>
              <th>Fix</th>
            </tr>
            <tr>
              <td><code>wiring/index.ts</code> L120</td>
              <td>Accept Zod schema param in cache get</td>
            </tr>
            <tr>
              <td><code>auto-tagging.service.ts</code> L309</td>
              <td>Zod validate LLM output</td>
            </tr>
            <tr>
              <td><code>auto-tagging.service.ts</code> L372</td>
              <td>Zod validate LLM output</td>
            </tr>
            <tr>
              <td><code>CookieConsentBanner.tsx</code> L42</td>
              <td>Zod validate localStorage</td>
            </tr>
            <tr>
              <td><code>media/route.ts</code> L119</td>
              <td>Wrap in try/catch</td>
            </tr>
          </table>
        </div>
        <div class="card">
          <div class="card-header">âš ï¸ Unsafe Non-null Assertions (4)</div>
          <table>
            <tr>
              <th>File</th>
              <th>Fix</th>
            </tr>
            <tr>
              <td><code>seo.service.ts</code> L1459</td>
              <td>Add null guard before <code>.match()</code></td>
            </tr>
            <tr>
              <td><code>MediaManager.tsx</code> L2511</td>
              <td>Add <code>if (!state.detailItem) return</code></td>
            </tr>
            <tr>
              <td><code>ads/page.tsx</code> L1098</td>
              <td>Add <code>?? []</code> fallback</td>
            </tr>
            <tr>
              <td><code>AdminShell.tsx</code> L262</td>
              <td>Use optional chaining <code>?.</code></td>
            </tr>
          </table>
        </div>
      </div>

      <!-- 8.4 Zod/API/Prisma -->
      <h3 id="audit-zod">8.4 Zod / Prisma / API Misalignment</h3>
      <div class="alert alert-danger">
        <strong>ğŸ”´ CRITICAL:</strong> Self-service password change is
        <strong>completely broken</strong>. Profile page sends
        <code>{currentPassword, newPassword}</code> to
        <code>PATCH /api/users</code> which requires admin-level auth â†’ regular
        users get 403. The <code>changePasswordSchema</code> in auth/schemas.ts
        exists but is never used by any route.
      </div>

      <table>
        <tr>
          <th>Severity</th>
          <th>Issue</th>
          <th>File(s)</th>
        </tr>
        <tr>
          <td class="severity-critical">CRITICAL</td>
          <td>Password change sends to admin-only endpoint</td>
          <td><code>profile/page.tsx</code> â†’ <code>/api/users</code></td>
        </tr>
        <tr>
          <td class="severity-high">HIGH</td>
          <td>Comment status moderation â€” no Zod validation for status enum</td>
          <td><code>comments/[id]/route.ts</code></td>
        </tr>
        <tr>
          <td class="severity-high">HIGH</td>
          <td>Tags bulk threshold â€” no validation</td>
          <td><code>tags/bulk/route.ts</code></td>
        </tr>
        <tr>
          <td class="severity-high">HIGH</td>
          <td><code>z.any()</code> on menuStructure â€” disables type safety</td>
          <td><code>settings/schemas.ts</code></td>
        </tr>
        <tr>
          <td class="severity-medium">MEDIUM</td>
          <td>8 routes missing Zod GET param validation</td>
          <td>posts, tags, admin-bar/meta, newsletter/*</td>
        </tr>
        <tr>
          <td class="severity-medium">MEDIUM</td>
          <td>Inline schemas diverged from shared schemas</td>
          <td>users, profile, posts/bulk, media query</td>
        </tr>
        <tr>
          <td class="severity-medium">MEDIUM</td>
          <td><code>twitterCard</code> missing from UpdatePostSchema</td>
          <td><code>blog/schemas.ts</code></td>
        </tr>
        <tr>
          <td class="severity-medium">MEDIUM</td>
          <td>
            Settings type erased to <code>Record&lt;string, unknown&gt;</code>
          </td>
          <td><code>/api/settings PATCH</code></td>
        </tr>
        <tr>
          <td class="severity-low">LOW</td>
          <td>
            Unused shared schemas: PostListSchema, adminCreateUserSchema,
            changePasswordSchema
          </td>
          <td><code>blog/schemas.ts</code>, <code>auth/schemas.ts</code></td>
        </tr>
      </table>

      <!-- 8.5 Frontend -->
      <h3 id="audit-frontend">8.5 Frontend Data Flow Issues</h3>
      <table>
        <tr>
          <th>Issue</th>
          <th>Count</th>
          <th>Impact</th>
        </tr>
        <tr>
          <td>
            Admin pages missing <code>res.ok</code> guard before
            <code>res.json()</code>
          </td>
          <td>14 pages</td>
          <td>502/503 â†’ JSON parse crash</td>
        </tr>
        <tr>
          <td>
            All API responses typed as <code>any</code> (no response DTOs)
          </td>
          <td>All pages</td>
          <td>No compile-time safety</td>
        </tr>
        <tr>
          <td>PostEditor sends dead fields (wordCount, readingTime)</td>
          <td>1 page</td>
          <td>Silently stripped by Zod</td>
        </tr>
        <tr>
          <td>Comments delete unchecked â€” toasts success without checking</td>
          <td>1 page</td>
          <td>False success on failure</td>
        </tr>
        <tr>
          <td>SEO page silently swallows 10+ errors</td>
          <td>1 page</td>
          <td>No user feedback on failures</td>
        </tr>
        <tr>
          <td>PostEditor tag/category fetch â€” no error handling</td>
          <td>1 page</td>
          <td>Silent empty state</td>
        </tr>
        <tr>
          <td>Tags page does client-side pagination (fetches ALL)</td>
          <td>1 page</td>
          <td>Inconsistent + slow at scale</td>
        </tr>
        <tr>
          <td>DataTable component exists but is unused by any admin page</td>
          <td>All pages</td>
          <td>7 custom tables duplicated</td>
        </tr>
        <tr>
          <td>Bulk action pattern copy-pasted 7 times</td>
          <td>7 pages</td>
          <td>Maintenance burden</td>
        </tr>
        <tr>
          <td>
            Public pages use <code>Record&lt;string, unknown&gt;</code> casts
            for settings
          </td>
          <td>3 pages</td>
          <td>Type safety bypass</td>
        </tr>
      </table>

      <!-- 8.6 Security -->
      <h3 id="audit-security">8.6 Security Audit</h3>
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">âœ… Strong Points</div>
          <ul style="padding-left: 1.2rem">
            <li>
              <span class="check">âœ“</span> Nonce-based CSP (no
              <code>unsafe-eval</code>)
            </li>
            <li>
              <span class="check">âœ“</span> CSRF double-submit cookie pattern
            </li>
            <li>
              <span class="check">âœ“</span> HSTS, X-Frame-Options: DENY, nosniff
            </li>
            <li>
              <span class="check">âœ“</span> All DB access via Prisma
              (parameterized)
            </li>
            <li>
              <span class="check">âœ“</span> Comprehensive sanitization utilities
            </li>
            <li>
              <span class="check">âœ“</span> Capability-based RBAC + privilege
              escalation prevention
            </li>
            <li><span class="check">âœ“</span> CRON_SECRET header gate</li>
            <li>
              <span class="check">âœ“</span> Rate limiting on mutations (30/60s)
            </li>
          </ul>
        </div>
        <div class="card">
          <div class="card-header">âš ï¸ Hardening Needed</div>
          <ul style="padding-left: 1.2rem">
            <li>
              <span class="warn">â–³</span>
              <code>style-src 'unsafe-inline'</code> â€” needed for
              Tailwind/next-themes
            </li>
            <li>
              <span class="warn">â–³</span> Rate limit uses
              <code>x-forwarded-for</code> (spoofable) â€” should prefer
              <code>x-real-ip</code>
            </li>
            <li>
              <span class="warn">â–³</span> Newsletter subscribe skips CSRF + no
              CAPTCHA
            </li>
            <li>
              <span class="warn">â–³</span> <code>$queryRawUnsafe</code> used
              (safely parameterized, but <code>$queryRaw</code> is
              defense-in-depth)
            </li>
            <li>
              <span class="warn">â–³</span> Permissions-Policy could deny more
              browser features
            </li>
          </ul>
        </div>
      </div>

      <!-- 8.7 Dead Code -->
      <h3 id="audit-dead">8.7 Dead Code &amp; Unused Dependencies</h3>
      <div class="grid grid-3">
        <div class="card">
          <div class="card-header">ğŸ“¦ Dead npm Packages (3)</div>
          <ul style="padding-left: 1rem">
            <li><code>openai</code> â€” never imported</li>
            <li><code>slugify</code> â€” never imported</li>
            <li><code>@tiptap/extension-floating-menu</code></li>
          </ul>
        </div>
        <div class="card">
          <div class="card-header">ğŸ—‘ï¸ Dead Files (1)</div>
          <ul style="padding-left: 1rem">
            <li><code>components/admin/useSeoScore.ts</code></li>
          </ul>
          <div class="card-header" style="margin-top: 0.5rem">
            ğŸ—‘ï¸ Dead Types (2)
          </div>
          <ul style="padding-left: 1rem">
            <li><code>TagItem</code> in prisma-helpers.ts</li>
            <li><code>CommentItem</code> in prisma-helpers.ts</li>
          </ul>
        </div>
        <div class="card">
          <div class="card-header">ğŸ—‘ï¸ Dead UI Exports (9)</div>
          <ul style="padding-left: 1rem; font-size: 0.85rem">
            <li>Card, CardHeader, CardTitle</li>
            <li>EmptyState, Skeleton, StatCard</li>
            <li>DataTable, Pagination, Column</li>
            <li>Tabs, useFormAction</li>
          </ul>
          <div class="card-header" style="margin-top: 0.5rem">
            ğŸ—‘ï¸ Dead Prisma Models (2)
          </div>
          <ul style="padding-left: 1rem">
            <li><code>Job</code> â€” scaffolded, unused (will activate)</li>
            <li><code>MediaSetting</code> â€” never queried</li>
          </ul>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 9. PHASES                                                          -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="phases">9. Implementation Phases (1â€“12)</h2>

      <div class="phase phase-1">
        <h3>
          Phase 1: Route Group Restructure
          <span class="badge badge-blue">42 file moves</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>
            Create <code>(public)/</code>, <code>(auth)/</code>,
            <code>(admin)/</code> route groups
          </li>
          <li>Move 12 public pages â†’ <code>(public)/</code></li>
          <li>Move 6 auth pages â†’ <code>(auth)/</code></li>
          <li>Move 24 admin pages â†’ <code>(admin)/admin/</code></li>
          <li>
            Extract <code>PublicShell</code> from root layout â†’
            <code>(public)/layout.tsx</code>
          </li>
          <li>
            Merge 3 identical auth layouts â†’ single
            <code>(auth)/layout.tsx</code>
          </li>
          <li>Update all internal <code>@/app/</code> import paths</li>
        </ul>
      </div>

      <div class="phase phase-2">
        <h3>
          Phase 2: Boundary Files
          <span class="badge badge-green">8 new files</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li><code>not-found.tsx</code> â€” branded 404</li>
          <li><code>error.tsx</code> Ã— 3 â€” public, post-specific, admin</li>
          <li>
            <code>loading.tsx</code> Ã— 4 â€” blog list, single post, tags, admin
          </li>
        </ul>
      </div>

      <div class="phase phase-3">
        <h3>
          Phase 3: Private Folders
          <span class="badge badge-purple">6 file moves</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>
            CommentSection â†’ <code>_ui/</code>, ContactForm â†’ <code>_ui/</code>,
            SearchContent â†’ <code>_ui/</code>
          </li>
          <li>
            AdminShell â†’ <code>_ui/</code>, PostEditor â†’ <code>_ui/</code>,
            PageEditor â†’ <code>_ui/</code>
          </li>
        </ul>
      </div>

      <div class="phase phase-4">
        <h3>
          Phase 4: Eliminate All Double Casts
          <span class="badge badge-red">156 fixes</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>
            Create <code>AppPrismaClient</code> intersection type (eliminates
            ~40 wiring casts)
          </li>
          <li>
            Use <code>Prisma.*WhereInput</code>/<code>StringFilter</code>
            (eliminates ~15 query casts)
          </li>
          <li>
            Zod validate JSON columns at DB boundary (eliminates ~12
            admin-settings casts)
          </li>
          <li>
            Make <code>InterlinkPrisma</code>/<code>ScanPrisma</code> structural
            subtypes (eliminates ~15)
          </li>
          <li>
            Add Ads delegates to <code>AppPrismaClient</code> (eliminates ~8)
          </li>
          <li>
            Fix misc: global augmentation, Omit&lt;&gt; return, shape validation
            (~10)
          </li>
        </ul>
      </div>

      <div class="phase phase-5">
        <h3>
          Phase 5: Eliminate All Loose <code>any</code>
          <span class="badge badge-orange">90+ fixes</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>
            Create generic <code>PrismaDelegate&lt;T&gt;</code> interface
            (replaces ~80 <code>any</code> params across 10 types files)
          </li>
          <li>
            Type Distribution service (15+ <code>any</code> â†’ proper
            input/output types)
          </li>
          <li>Type Ads service (12+ <code>any</code> â†’ Prisma types)</li>
          <li>
            Fix all <code>catch (err: any)</code> â†’
            <code>catch (err: unknown)</code>
          </li>
        </ul>
      </div>

      <div class="phase phase-6">
        <h3>
          Phase 6: JSON.parse &amp; Non-null Fixes
          <span class="badge badge-green">12 fixes</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>Add Zod validation to 5 risky <code>JSON.parse</code> calls</li>
          <li>
            Replace 5 <code>JSON.parse(JSON.stringify())</code> â†’
            <code>structuredClone()</code>
          </li>
          <li>Fix 4 unsafe <code>!</code> assertions with proper guards</li>
        </ul>
      </div>

      <div class="phase phase-7">
        <h3>
          Phase 7: Zod / API / Prisma Alignment
          <span class="badge badge-red">CRITICAL</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>
            ğŸ”´ Fix broken password change â€” create
            <code>/api/profile/password</code>
          </li>
          <li>Add Zod to 8 unvalidated routes</li>
          <li>Replace 6 inline schemas with shared schemas</li>
          <li>Fix 4 Prisma â†” Zod field mismatches</li>
          <li>Fix Settings type erasure at service boundary</li>
        </ul>
      </div>

      <div class="phase phase-8">
        <h3>
          Phase 8: Frontend Data Flow
          <span class="badge badge-orange">14 pages fixed</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>Add <code>res.ok</code> guards to all 14 admin pages</li>
          <li>
            Create <code>ApiResponse&lt;T&gt;</code> generic response type
          </li>
          <li>Fix PostEditor dead data sends</li>
          <li>Fix comments delete unchecked response</li>
          <li>Fix SEO page silent error swallowing (10+ catch blocks)</li>
          <li>
            Fix public page <code>Record&lt;string, unknown&gt;</code> casts
          </li>
        </ul>
      </div>

      <div class="phase phase-9">
        <h3>
          Phase 9: Dead Code &amp; Security
          <span class="badge badge-green">cleanup</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>Remove 3 dead npm packages</li>
          <li>Remove dead file, dead types, dead UI exports</li>
          <li>Use <code>x-real-ip</code> as primary rate limit IP source</li>
          <li>Extend Permissions-Policy header</li>
          <li>Document <code>style-src unsafe-inline</code> necessity</li>
        </ul>
      </div>

      <div class="phase phase-10">
        <h3>
          Phase 10: Job Runner System
          <span class="badge badge-purple">NEW module</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>
            Create <code>features/jobs/server/</code> â€” queue, runner,
            dispatcher, idempotency, definitions
          </li>
          <li>
            Create 4 workflow files (SEO planner, image gen, distribution, blog
            autopublish)
          </li>
          <li>
            Create <code>/api/jobs/enqueue</code> +
            <code>/api/jobs/run</code> endpoints
          </li>
          <li>Wire into existing cron (process-pending-jobs task)</li>
        </ul>
      </div>

      <div class="phase phase-11">
        <h3>
          Phase 11: Server Actions Wave 1
          <span class="badge badge-orange">leaf CRUD</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>Tags CRUD â†’ <code>features/tags/server/actions.ts</code></li>
          <li>
            Categories CRUD â†’
            <code>features/blog/server/category-actions.ts</code>
          </li>
          <li>
            Media Folders â†’ <code>features/media/server/folder-actions.ts</code>
          </li>
          <li>
            Settings, Ads, Distribution, Auth, Media â†’ <code>actions.ts</code>
          </li>
          <li>Keep API routes alive (deprecate, don't delete)</li>
        </ul>
      </div>

      <div class="phase phase-12">
        <h3>
          Phase 12: Instrumentation &amp; Consistency
          <span class="badge badge-blue">polish</span>
        </h3>
        <ul style="padding-left: 1.2rem">
          <li>Add <code>instrumentation.ts</code> for OpenTelemetry</li>
          <li>Tags admin â€” add server-side pagination</li>
          <li>
            Extract <code>useBulkSelection</code> shared hook (eliminate 7Ã—
            copy-paste)
          </li>
          <li>Create shared <code>handleApiResponse()</code> utility</li>
        </ul>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 10. JOB RUNNER                                                     -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="job-runner">10. Job Runner Architecture</h2>

      <div class="card">
        <h4>Step-Based Workflow Design (Vercel-Optimized)</h4>
        <p style="margin: 0.5rem 0">
          Each autonomous workflow runs as a series of small steps (&lt;10s
          each), persisted between invocations. This avoids Vercel's function
          duration limits and keeps compute costs predictable.
        </p>

        <div class="tree" style="margin: 1rem 0">
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Cron Tick
          â”‚â”€â”€â”€â”€â–¶â”‚ /api/jobs/runâ”‚â”€â”€â”€â”€â–¶â”‚ runner.ts â”‚ â”‚ (hourly) â”‚ â”‚ (POST) â”‚ â”‚
          processNextJob()â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ dispatcher.ts â”‚ â”‚ type+stepâ†’fn() â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          seo-planner.ts â”‚ â”‚ image-gen.ts â”‚ â”‚ distribution.ts â”‚ â”‚ Steps: â”‚ â”‚
          Steps: â”‚ â”‚ Steps: â”‚ â”‚ 1. analyze â”‚ â”‚ 1. extract â”‚ â”‚ 1. select targets
          â”‚ â”‚ 2. research â”‚ â”‚ 2. prompt â”‚ â”‚ 2. format â”‚ â”‚ 3. score â”‚ â”‚ 3.
          generate â”‚ â”‚ 3. distribute â”‚ â”‚ 4. suggest â”‚ â”‚ 4. store â”‚ â”‚ 4. verify â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          Each step: pick PENDING â†’ lock (Redis) â†’ execute â†’ save result â†’
          enqueue next step â†’ unlock
        </div>

        <table>
          <tr>
            <th>Property</th>
            <th>Value</th>
            <th>Reason</th>
          </tr>
          <tr>
            <td>Max step duration</td>
            <td>10 seconds</td>
            <td>Vercel function timeout safety margin</td>
          </tr>
          <tr>
            <td>Steps per cron tick</td>
            <td>5</td>
            <td>50s total within 60s cron limit</td>
          </tr>
          <tr>
            <td>Retry strategy</td>
            <td>3 attempts, exponential backoff</td>
            <td>Resilience against transient failures</td>
          </tr>
          <tr>
            <td>Idempotency</td>
            <td>Redis dedup key per job ID</td>
            <td>Prevent double-processing</td>
          </tr>
          <tr>
            <td>Concurrency</td>
            <td>Per-job Redis lock</td>
            <td>No parallel execution of same job</td>
          </tr>
          <tr>
            <td>Persistence</td>
            <td>Job.result JSON between steps</td>
            <td>Survives function cold starts</td>
          </tr>
        </table>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 11. SERVER ACTIONS                                                 -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="server-actions">11. Server Actions Migration Plan</h2>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-header" style="color: var(--green)">
            âœ… Migrate to Server Actions
          </div>
          <table>
            <tr>
              <th>Route</th>
              <th>Action File</th>
            </tr>
            <tr>
              <td>Tags CRUD</td>
              <td><code>tags/server/actions.ts</code></td>
            </tr>
            <tr>
              <td>Categories CRUD</td>
              <td><code>blog/server/category-actions.ts</code></td>
            </tr>
            <tr>
              <td>Media Folders</td>
              <td><code>media/server/folder-actions.ts</code></td>
            </tr>
            <tr>
              <td>Settings test-email</td>
              <td><code>settings/server/actions.ts</code></td>
            </tr>
            <tr>
              <td>Ads kill-switch</td>
              <td><code>ads/server/actions.ts</code></td>
            </tr>
            <tr>
              <td>Distribution channels</td>
              <td><code>distribution/server/actions.ts</code></td>
            </tr>
            <tr>
              <td>Users bulk</td>
              <td><code>auth/server/actions.ts</code></td>
            </tr>
            <tr>
              <td>Media items</td>
              <td><code>media/server/actions.ts</code></td>
            </tr>
          </table>
        </div>
        <div class="card">
          <div class="card-header" style="color: var(--red)">
            âŒ Keep as API Routes
          </div>
          <table>
            <tr>
              <th>Route</th>
              <th>Reason</th>
            </tr>
            <tr>
              <td>Comments POST</td>
              <td>Public consumers (blog pages)</td>
            </tr>
            <tr>
              <td>Contact POST</td>
              <td>Public form submission</td>
            </tr>
            <tr>
              <td>Newsletter *</td>
              <td>Public subscribe/confirm/unsub</td>
            </tr>
            <tr>
              <td>Captcha *</td>
              <td>Public challenge/verify</td>
            </tr>
            <tr>
              <td>Auth *</td>
              <td>NextAuth handles routing</td>
            </tr>
            <tr>
              <td>Posts CRUD</td>
              <td>Complex orchestration</td>
            </tr>
            <tr>
              <td>Pages CRUD</td>
              <td>Complex orchestration</td>
            </tr>
            <tr>
              <td>SEO *</td>
              <td>Complex multi-step</td>
            </tr>
            <tr>
              <td>Cron</td>
              <td>External scheduler</td>
            </tr>
            <tr>
              <td>Health</td>
              <td>External monitoring</td>
            </tr>
            <tr>
              <td>OG image</td>
              <td>External consumers</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 12. VERIFICATION                                                   -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="verification">12. Verification Checklist</h2>

      <table>
        <tr>
          <th>Check</th>
          <th>Command</th>
          <th>Expected</th>
        </tr>
        <tr>
          <td>TypeScript</td>
          <td><code>npx tsc --noEmit</code></td>
          <td>0 errors</td>
        </tr>
        <tr>
          <td>ESLint</td>
          <td><code>npx eslint .</code></td>
          <td>0 errors, 0 warnings</td>
        </tr>
        <tr>
          <td>Build</td>
          <td><code>npx next build</code></td>
          <td>0 errors, clean output</td>
        </tr>
        <tr>
          <td>Unit tests (Vitest)</td>
          <td><code>npx vitest run</code></td>
          <td>All pass</td>
        </tr>
        <tr>
          <td>Server tests (Jest)</td>
          <td><code>npx jest --runInBand</code></td>
          <td>All pass</td>
        </tr>
        <tr>
          <td>E2E tests (Playwright)</td>
          <td><code>npx playwright test</code></td>
          <td>All pass</td>
        </tr>
        <tr>
          <td>Double casts</td>
          <td><code>grep -r "as unknown as" src/ | wc -l</code></td>
          <td>Near 0 (only justified with SAFETY comment)</td>
        </tr>
        <tr>
          <td>Loose any</td>
          <td><code>grep -r ": any" src/ | wc -l</code></td>
          <td>Near 0</td>
        </tr>
        <tr>
          <td>Unvalidated JSON.parse</td>
          <td><code>grep -r "JSON.parse" src/ | grep -v safeParse</code></td>
          <td>All wrapped in try/catch + Zod</td>
        </tr>
        <tr>
          <td>Dead exports</td>
          <td><code>npx knip</code></td>
          <td>0 unused exports/deps</td>
        </tr>
        <tr>
          <td>URL routing</td>
          <td>All public URLs unchanged</td>
          <td>Route groups invisible</td>
        </tr>
        <tr>
          <td>Password change</td>
          <td>Test as regular user</td>
          <td>Must succeed</td>
        </tr>
      </table>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- 13. DECISIONS                                                      -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <h2 id="decisions">13. Key Architectural Decisions</h2>

      <table>
        <tr>
          <th>Decision</th>
          <th>Choice</th>
          <th>Rationale</th>
        </tr>
        <tr>
          <td>Structure approach</td>
          <td>Feature-First (Option B) enhanced</td>
          <td>
            Already established; monorepo (Option C) is tooling overhead while
            solo
          </td>
        </tr>
        <tr>
          <td>Route groups</td>
          <td>
            <code>(public)</code>, <code>(auth)</code>, <code>(admin)</code>
          </td>
          <td>Layout isolation, code splitting, PublicShell fix</td>
        </tr>
        <tr>
          <td>Server Actions scope</td>
          <td>Leaf CRUD only</td>
          <td>Complex orchestration stays API; public forms stay API</td>
        </tr>
        <tr>
          <td>Job runner</td>
          <td>Integrated into existing cron</td>
          <td>No separate worker; step-based within 60s limit</td>
        </tr>
        <tr>
          <td>Prisma typing</td>
          <td><code>AppPrismaClient</code> intersection</td>
          <td>
            Eliminates ~40 double casts in wiring with one architectural change
          </td>
        </tr>
        <tr>
          <td>Delegate typing</td>
          <td>Generic <code>PrismaDelegate&lt;T&gt;</code></td>
          <td>Eliminates ~80 <code>any</code> params across 10 types files</td>
        </tr>
        <tr>
          <td>Rate limit IP</td>
          <td><code>x-real-ip</code> primary</td>
          <td>Defense against <code>x-forwarded-for</code> spoofing</td>
        </tr>
        <tr>
          <td>CSP style-src</td>
          <td>Keep <code>unsafe-inline</code></td>
          <td>Required for Tailwind + next-themes; documented</td>
        </tr>
        <tr>
          <td>Entry point</td>
          <td><code>proxy.ts</code> (NOT <code>middleware.ts</code>)</td>
          <td>Next.js 16 convention</td>
        </tr>
        <tr>
          <td>UI library</td>
          <td>Tailwind + Headless UI (NO MUI)</td>
          <td>Leaner bundle, lower cost, already established</td>
        </tr>
        <tr>
          <td>Dead packages</td>
          <td>
            Remove <code>openai</code>, <code>slugify</code>,
            <code>floating-menu</code>
          </td>
          <td>Never imported in source</td>
        </tr>
        <tr>
          <td>Job model</td>
          <td>Activate existing scaffolded model</td>
          <td>Schema already has type/step/status/payload/result/attempts</td>
        </tr>
      </table>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- FOOTER                                                             -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <hr style="border-color: var(--border); margin: 3rem 0 1.5rem" />
      <p style="color: var(--muted); text-align: center; font-size: 0.85rem">
        MyBlog Architecture Blueprint â€” Generated February 20, 2026<br />
        Next.js 16.1.6 â€¢ React 19.2.3 â€¢ Prisma 7.4.0 â€¢ TypeScript 5 â€¢ Tailwind
        v4 â€¢ Vercel Deployment
      </p>
    </div>
    <!-- .container -->
  </body>
</html>
